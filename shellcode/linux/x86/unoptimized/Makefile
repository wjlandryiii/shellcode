BUILDSCRIPTSDIR=../../../../build_scripts/
SRCDIR=src
OBJDIR=obj
ELFDIR=elf
BINDIR=bin
PYDIR=py

SOURCES = $(notdir $(wildcard src/*.s))
PYSOURCES = $(wildcard src/*.py)

SRCS=$(addprefix $(SRCDIR)/,$(SOURCES))
OBJS=$(addprefix $(OBJDIR)/,$(SOURCES:.s=.o))
ELFS=$(addprefix $(ELFDIR)/,$(SOURCES:.s=.elf))
BINS=$(addprefix $(BINDIR)/,$(SOURCES:.s=.bin))
PYS=$(addprefix $(PYDIR)/,$(SOURCES:.s=.py))

TESTS=$(notdir $(basename $(wildcard tests/*.py)))

all: $(OBJS) $(ELFS) $(BINS) $(PYS) shellcode.py

$(OBJS): | $(OBJDIR)
$(ELFS): | $(ELFDIR)
$(BINS): | $(BINDIR)
$(PYS): | $(PYDIR)

$(OBJDIR):
	mkdir -p obj
$(ELFDIR):
	mkdir -p elf
$(BINDIR):
	mkdir -p bin
$(PYDIR):
	mkdir -p py

$(OBJDIR)/%.o: $(SRCDIR)/%.s
	as -o $@ $<

$(ELFDIR)/%.elf: $(OBJDIR)/%.o
	ld -o $@ $<

$(BINDIR)/%.bin: $(ELFDIR)/%.elf
	objcopy -O binary --only-section=.text $< $@

$(PYDIR)/%.py: $(BINDIR)/%.bin
	$(BUILDSCRIPTSDIR)/bin2py.py $(notdir $(basename $@))_shellcode $< $@

shellcode.py: $(PYS) $(PYSOURCES)
	echo \#!/usr/bin/python > shellcode.py
	echo >> shellcode.py
	echo \# THIS FILE WAS GENERATED BY RUNNING MAKE >>shellcode.py
	echo \# IF YOU WANT TO  MODIFY THIS FILE, YOU SHOULD MODIFY THE SOURCE IN src/ THEN RUN make >> shellcode.py
	echo >> shellcode.py
	echo \# Date Created: >> shellcode.py
	date -u | sed  "s/^\([^\#]\)/# \1/g" >> shellcode.py
	echo >> shellcode.py
	echo \# uname -a: >>shellcode.py
	uname -a | sed  "s/^\([^\#]\)/# \1/g" >> shellcode.py
	echo >> shellcode.py
	echo \# assembler: >> shellcode.py
	as --version | sed  "s/^\([^\#]\)/# \1/g" >> shellcode.py
	echo >> shellcode.py
	cat $(PYS) >> shellcode.py
	cat $(PYSOURCES) >> shellcode.py

test: testing/runsc $(TESTS)

$(TESTS):
	python -m tests.$@

testing/runsc:
	make -C testing all

.PHONY: clean
clean:
	rm -f $(OBJDIR)/*
	rm -f $(ELFDIR)/*
	rm -f $(BINDIR)/*
	rm -f $(PYDIR)/*
	rm -f shellcode.py
	make -C testing clean

